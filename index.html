<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoio Amigo - Vers√£o Final Consolidada</title>
    <style>
        :root {
            --bg-chat: #e5ddd5;
            --header-color: #075e54;
            --msg-bot: #ffffff;
            --msg-user: #dcf8c6;
            --text-main: #303030;
            --text-sub: #999;
            --input-bg: #f0f0f0;
            --chat-window-bg: #efe7dd;
        }

        body.dark-mode {
            --bg-chat: #0b141a;
            --header-color: #202c33;
            --msg-bot: #202c33;
            --msg-user: #005c4b;
            --text-main: #e9edef;
            --text-sub: #8696a0;
            --input-bg: #2a3942;
            --chat-window-bg: #0b141a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-chat); display: flex; justify-content: center; height: 100vh; overflow: hidden; transition: 0.3s; }

        .chat-container { width: 100%; max-width: 450px; background: var(--chat-window-bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.2); }

        .header { background: var(--header-color); color: white; padding: 15px; display: flex; align-items: center; gap: 12px; z-index: 10; }
        .header img { width: 40px; height: 40px; border-radius: 50%; background: #eee; }
        .header-info { flex: 1; }
        .header-info h2 { font-size: 16px; }
        .header-info p { font-size: 11px; opacity: 0.8; }
        .btn-header { background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 5px; opacity: 0.8; }

        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

        .message { max-width: 85%; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.5; color: var(--text-main); position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .bot { background: var(--msg-bot); align-self: flex-start; border-top-left-radius: 0; }
        .user { background: var(--msg-user); align-self: flex-end; border-top-right-radius: 0; }
        .time { font-size: 10px; color: var(--text-sub); text-align: right; margin-top: 5px; }

        .topics-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; width: 85%; align-self: flex-start; }
        .topic-btn { background: var(--msg-bot); border: 1px solid var(--header-color); color: var(--text-main); padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; text-align: left; }
        .topic-btn.emergency { border-color: #ff4b2b; color: #ff4b2b; font-weight: bold; }

        .input-area { background: var(--input-bg); padding: 10px; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: none; border-radius: 25px; outline: none; background: var(--msg-bot); color: var(--text-main); }
        #send-btn { background: var(--header-color); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        #sos-btn { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: #ff4b2b; color: white; border: none; font-weight: bold; cursor: pointer; z-index: 99; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #sos-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-chat); color: var(--text-main); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        #breath-circle { width: 160px; height: 160px; border-radius: 50%; border: 3px solid #ff4b2b; display: flex; align-items: center; justify-content: center; transition: 4s ease-in-out; margin: 30px 0; }

        .typing { font-size: 12px; color: var(--text-sub); margin: 5px 15px; display: none; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" alt="Bot">
        <div class="header-info">
            <h2>Guia de Bem-Estar</h2>
            <p>Um dia de cada vez</p>
        </div>
        <button class="btn-header" onclick="toggleTheme()">üåì</button>
        <button class="btn-header" onclick="reiniciarConversa()">‚Üª</button>
    </div>

    <div id="chat-window"></div>
    <div id="typing-indicator" class="typing">digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Escreva aqui...">
        <button id="send-btn">‚û§</button>
    </div>
</div>

<button id="sos-btn">SOS</button>

<div id="sos-overlay">
    <h1 style="color: #ff4b2b;">Respire Fundo</h1>
    <div id="breath-circle"><span id="breath-text" style="color:#ff4b2b; font-weight:bold;">Inspirar</span></div>
    <div style="max-width: 350px; width: 100%;">
        <a href="tel:188" style="display: block; background: #ff4b2b; color: white; padding: 15px; text-decoration: none; border-radius: 30px; margin-bottom: 15px; font-weight: bold;">LIGAR PARA O CVV (188)</a>
        <button onclick="fecharSOS()" style="background: none; border: 1px solid var(--text-sub); padding: 10px 20px; border-radius: 20px; cursor: pointer; color: var(--text-sub);">Voltar ao chat</button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const somNotificacao = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

    // Estados
    let modoGratidao = false;
    let modoInventario = false;
    let etapaInventario = 0;
    let respostasInventario = [];
    let sosInterval;
    let progresso = JSON.parse(localStorage.getItem('progresso_vFinal')) || { gratidao: 0, exercicios: 0, conversas: 0 };

    const afirmacoes = [
        "Sou capaz de lidar com os desafios de hoje.",
        "Respeito meu ritmo e honro meus progressos.",
        "N√£o preciso ser perfeito para ser incr√≠vel.",
        "Minha jornada √© √∫nica, n√£o me comparo.",
        "Eu escolho focar no que posso controlar.",
        "A cada respira√ß√£o, libero as tens√µes.",
        "Sou digno(a) de paz e cuidado agora.",
        "Minha sensibilidade √© minha for√ßa.",
        "Um dia dif√≠cil n√£o define minha vida.",
        "Tenho o direito de estabelecer limites."
    ];

    const dadosSentimentos = {
        ansiedade: { 
            resposta: "A ansiedade tenta te levar para um futuro que ainda n√£o existe. Vamos voltar para o aqui e agora?",
            exercicio: "üßò **T√©cnica 5-4-3-2-1**: Diga 5 coisas que voc√™ v√™, 4 que pode tocar, 3 sons que ouve, 2 cheiros e 1 sabor."
        },
        panico: { 
            resposta: "Sinta seus p√©s firmes no ch√£o. Essa sensa√ß√£o f√≠sica √© passageira e voc√™ est√° em seguran√ßa.",
            exercicio: "üå¨Ô∏è **Respira√ß√£o Quadrada**: Inspire (4s), segure (4s), expire (4s), espere (4s). Repita 3 vezes."
        },
        sobrecarga: { 
            resposta: "Parece que voc√™ est√° carregando o mundo. Lembre-se: voc√™ n√£o precisa resolver tudo hoje.",
            exercicio: "üö∂ **Pausa de Al√≠vio**: Beba um copo de √°gua bem devagar e sinta a temperatura. Alongue os bra√ßos."
        },
        solidao: { 
            resposta: "A solid√£o d√≥i, mas eu estou aqui com voc√™ agora. Vamos acolher esse sentimento com carinho?",
            exercicio: "üìñ **A√ß√£o**: Liste 2 coisas que voc√™ gosta em sua pr√≥pria companhia ou ou√ßa sua m√∫sica favorita."
        }
    };

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `${text}<div class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        if(type === 'bot') somNotificacao.play().catch(() => {});
    }

    function showTypingAndRespond(text, callback) {
        typingIndicator.style.display = 'block';
        setTimeout(() => {
            typingIndicator.style.display = 'none';
            addMessage(text, 'bot');
            if(callback) callback();
        }, 1500);
    }

    function exibirTopicosDeAjuda() {
        if (modoInventario || modoGratidao) return;
        const topicos = [
            { texto: "üò∞ Ansiedade/Medo", valor: "ansiedade" },
            { texto: "üö® Crise de P√¢nico", valor: "p√¢nico" },
            { texto: "üå± Reforma de Car√°ter", valor: "invent√°rio" },
            { texto: "ü§Ø Sobrecarga/Stress", valor: "sobrecarga" },
            { texto: "üíî Solid√£o", valor: "solid√£o" },
            { texto: "‚ú® Praticar Gratid√£o", valor: "gratid√£o" },
            { texto: "üìä Meu Progresso", valor: "progresso" }
        ];
        const container = document.createElement('div');
        container.className = 'topics-container';
        topicos.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'topic-btn' + (t.texto.includes("üö®") ? " emergency" : "");
            btn.innerText = t.texto;
            btn.onclick = () => { userInput.value = t.valor; processarEntrada(); container.remove(); };
            container.appendChild(btn);
        });
        chatWindow.appendChild(container);
    }

    function analisarEGerarFeedback() {
        let feedback = "";
        const todasRespostas = respostasInventario.join(" ").toLowerCase();
        if (todasRespostas.includes("sim") || todasRespostas.includes("orgulho") || todasRespostas.includes("raiva")) {
            feedback = "üìä **Feedback Sincero:** O orgulho √© um bloqueio para a cura. **A corre√ß√£o:** Pratique a humildade ainda hoje. Pe√ßa desculpas ou admita um erro para algu√©m.";
        } else if (todasRespostas.includes("menti") || todasRespostas.includes("escondi")) {
            feedback = "üìä **Feedback Sincero:** A mentira alimenta a doen√ßa. **A corre√ß√£o:** Admita a verdade imediatamente. A transpar√™ncia √© o que mant√©m voc√™ livre.";
        } else {
            feedback = "üìä **Feedback Sincero:** Olhar para si exige coragem. **A corre√ß√£o:** Saia do ego√≠smo praticando um ato de servi√ßo desinteressado para algu√©m agora.";
        }
        modoInventario = false;
        showTypingAndRespond(feedback, () => {
            setTimeout(() => showTypingAndRespond("Como se sente ap√≥s essa admiss√£o?", exibirTopicosDeAjuda), 2000);
        });
        progresso.exercicios++;
        localStorage.setItem('progresso_vFinal', JSON.stringify(progresso));
    }

    function processarEntrada() {
        const text = userInput.value.trim();
        if(!text) return;
        addMessage(text, 'user');
        userInput.value = '';
        progresso.conversas++;
        localStorage.setItem('progresso_vFinal', JSON.stringify(progresso));
        const lower = text.toLowerCase();

        // 1. MODO INVENT√ÅRIO
        if (modoInventario) {
            respostasInventario.push(lower);
            etapaInventario++;
            if (etapaInventario === 1) showTypingAndRespond("2. Voc√™ agiu com desonestidade ou tentou manipular algo para seu benef√≠cio hoje?");
            else if (etapaInventario === 2) showTypingAndRespond("3. O seu orgulho ou raiva impediram voc√™ de ser √∫til ou de admitir um erro?");
            else if (etapaInventario === 3) analisarEGerarFeedback();
            return;
        }

        // 2. MODO GRATID√ÉO
        if (modoGratidao) {
            showTypingAndRespond("Gratid√£o registrada! Isso fortalece sua mente. ‚ú®");
            progresso.gratidao++;
            localStorage.setItem('progresso_vFinal', JSON.stringify(progresso));
            modoGratidao = false; return;
        }

        // 3. IDENTIFICA√á√ÉO DE TEMAS
        if (lower.includes("carater") || lower.includes("invent√°rio") || lower.includes("reforma")) {
            modoInventario = true; etapaInventario = 0; respostasInventario = [];
            showTypingAndRespond("Iniciando invent√°rio moral. 1. Em que momento hoje voc√™ permitiu que o ego√≠smo ou o medo guiassem suas a√ß√µes?");
            return;
        }
        if (lower.includes("ansiedade") || lower.includes("ansioso") || lower.includes("medo")) {
            showTypingAndRespond(dadosSentimentos.ansiedade.resposta, () => {
                setTimeout(() => showTypingAndRespond(dadosSentimentos.ansiedade.exercicio), 2000);
            });
            return;
        }
        if (lower.includes("p√¢nico") || lower.includes("crise") || lower.includes("panico")) {
            showTypingAndRespond(dadosSentimentos.panico.resposta, () => {
                setTimeout(() => showTypingAndRespond(dadosSentimentos.panico.exercicio), 2000);
            });
            return;
        }
        if (lower.includes("sobrecarga") || lower.includes("stress") || lower.includes("cansado")) {
            showTypingAndRespond(dadosSentimentos.sobrecarga.resposta, () => {
                setTimeout(() => showTypingAndRespond(dadosSentimentos.sobrecarga.exercicio), 2000);
            });
            return;
        }
        if (lower.includes("solid√£o") || lower.includes("sozinho") || lower.includes("solidao")) {
            showTypingAndRespond(dadosSentimentos.solidao.resposta, () => {
                setTimeout(() => showTypingAndRespond(dadosSentimentos.solidao.exercicio), 2000);
            });
            return;
        }
        if (lower.includes("morrer") || lower.includes("desistir")) {
            showTypingAndRespond("Voc√™ √© importante. Por favor, ligue 188 agora (CVV). Existe ajuda.");
            return;
        }
        if (lower.includes("progresso")) {
            showTypingAndRespond(`üìä **Seu Progresso**\n\n‚ú® Gratid√µes: ${progresso.gratidao}\nüßò Exerc√≠cios: ${progresso.exercicios}\nüí¨ Conversas: ${progresso.conversas}`);
        } else if (lower.includes("gratid√£o") || lower.includes("agradecer")) {
            modoGratidao = true;
            showTypingAndRespond("‚ú® O que aconteceu de bom hoje?");
        } else {
            showTypingAndRespond("Como posso ajudar? Escolha um t√≥pico abaixo ou escreva o que sente agora.", exibirTopicosDeAjuda);
        }
    }

    function reiniciarConversa() { 
        modoInventario = false; modoGratidao = false; 
        chatWindow.innerHTML = ''; inicializarChat(); 
    }

    function inicializarChat() {
        const h = new Date().getHours();
        let s = h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        showTypingAndRespond(`${s}! Sou seu guia de bem-estar.`);
        setTimeout(() => {
            const f = afirmacoes[Math.floor(Math.random()*afirmacoes.length)];
            showTypingAndRespond(`‚ú® **Afirma√ß√£o:**\n"${f}"`);
        }, 3000);
        setTimeout(() => showTypingAndRespond("Escolha um t√≥pico ou escreva o que sente agora.", exibirTopicosDeAjuda), 5500);
    }

    document.getElementById('sos-btn').onclick = () => {
        sosOverlay.style.display = 'flex';
        let st = 0;
        sosInterval = setInterval(() => {
            document.getElementById('breath-circle').style.transform = st === 0 ? "scale(1.5)" : "scale(1.0)";
            document.getElementById('breath-text').innerText = st === 0 ? "Inspira" : "Expira";
            st = st === 0 ? 1 : 0;
        }, 4000);
    };

    function fecharSOS() { sosOverlay.style.display = 'none'; clearInterval(sosInterval); }
    sendBtn.onclick = processarEntrada;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') processarEntrada(); };

    window.onload = () => {
        const h = new Date().getHours();
        if(h >= 18 || h < 6) document.body.classList.add('dark-mode');
        inicializarChat();
    };
</script>
</body>
</html>
