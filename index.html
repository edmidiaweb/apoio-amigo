<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoio Amigo - Guia de Bem-Estar e Reforma de Car√°ter</title>
    <style>
        :root {
            --bg-chat: #e5ddd5;
            --header-color: #075e54;
            --msg-bot: #ffffff;
            --msg-user: #dcf8c6;
            --text-main: #303030;
            --text-sub: #999;
            --input-bg: #f0f0f0;
            --chat-window-bg: #efe7dd;
        }

        body.dark-mode {
            --bg-chat: #0b141a;
            --header-color: #202c33;
            --msg-bot: #202c33;
            --msg-user: #005c4b;
            --text-main: #e9edef;
            --text-sub: #8696a0;
            --input-bg: #2a3942;
            --chat-window-bg: #0b141a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Helvetica, sans-serif; }
        body { background-color: var(--bg-chat); display: flex; justify-content: center; height: 100vh; overflow: hidden; transition: 0.3s; }

        .chat-container { width: 100%; max-width: 450px; background: var(--chat-window-bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.2); }

        .header { background: var(--header-color); color: white; padding: 15px; display: flex; align-items: center; gap: 12px; z-index: 10; }
        .header img { width: 40px; height: 40px; border-radius: 50%; background: #eee; }
        .header-info { flex: 1; }
        .header-info h2 { font-size: 16px; }
        .header-info p { font-size: 11px; opacity: 0.8; }
        .btn-header { background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 5px; opacity: 0.8; }

        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

        .message { max-width: 85%; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.5; color: var(--text-main); position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .bot { background: var(--msg-bot); align-self: flex-start; border-top-left-radius: 0; }
        .user { background: var(--msg-user); align-self: flex-end; border-top-right-radius: 0; }
        .time { font-size: 10px; color: var(--text-sub); text-align: right; margin-top: 5px; }

        .topics-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; width: 85%; align-self: flex-start; }
        .topic-btn { background: var(--msg-bot); border: 1px solid var(--header-color); color: var(--text-main); padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; text-align: left; transition: 0.2s; }
        .topic-btn:hover { background: var(--input-bg); transform: translateX(5px); }
        .topic-btn.emergency { border-color: #ff4b2b; color: #ff4b2b; font-weight: bold; }

        .input-area { background: var(--input-bg); padding: 10px; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: none; border-radius: 25px; outline: none; background: var(--msg-bot); color: var(--text-main); }
        #send-btn { background: var(--header-color); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        #sos-btn { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: #ff4b2b; color: white; border: none; font-weight: bold; cursor: pointer; z-index: 99; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #sos-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-chat); color: var(--text-main); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        #breath-circle { width: 160px; height: 160px; border-radius: 50%; border: 3px solid #ff4b2b; display: flex; align-items: center; justify-content: center; transition: 4s ease-in-out; margin: 30px 0; }

        .typing { font-size: 12px; color: var(--text-sub); margin: 5px 15px; display: none; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" alt="Bot">
        <div class="header-info">
            <h2>Guia de Bem-Estar</h2>
            <p>Um dia de cada vez</p>
        </div>
        <button class="btn-header" onclick="toggleTheme()" title="Mudar Tema">üåì</button>
        <button class="btn-header" onclick="reiniciarConversa()" title="Reiniciar">‚Üª</button>
    </div>

    <div id="chat-window"></div>
    <div id="typing-indicator" class="typing">digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Diga como se sente...">
        <button id="send-btn">‚û§</button>
    </div>
</div>

<button id="sos-btn">SOS</button>

<div id="sos-overlay">
    <h1 style="color: #ff4b2b;">Respire com calma</h1>
    <div id="breath-circle"><span id="breath-text" style="color:#ff4b2b; font-weight:bold;">Inspirar</span></div>
    <div style="max-width: 350px; width: 100%;">
        <a href="tel:188" style="display: block; background: #ff4b2b; color: white; padding: 15px; text-decoration: none; border-radius: 30px; margin-bottom: 15px; font-weight: bold;">LIGAR PARA O CVV (188)</a>
        <button onclick="fecharSOS()" style="background: none; border: 1px solid var(--text-sub); padding: 10px 20px; border-radius: 20px; cursor: pointer; color: var(--text-sub);">Voltar ao chat</button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const somNotificacao = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

    let modoGratidao = false;
    let modoInventario = false;
    let etapaInventario = 0;
    let respostasInventario = [];
    let sosInterval;
    let progresso = JSON.parse(localStorage.getItem('progresso_vFinal')) || { gratidao: 0, exercicios: 0, conversas: 0 };

    const afirmacoes = [
        "Sou capaz de lidar com os desafios de hoje.",
        "Minha sensibilidade √© minha maior for√ßa.",
        "Respeito meu ritmo e honro meus progressos.",
        "Um dia dif√≠cil n√£o define minha vida.",
        "Sou digno(a) de paz e cuidado agora.",
        "N√£o preciso ser perfeito para ser incr√≠vel.",
        "Tenho o direito de estabelecer limites.",
        "Minha jornada √© √∫nica, n√£o preciso me comparar.",
        "Foco no que posso controlar e solto o resto.",
        "A cada respira√ß√£o, libero as tens√µes."
    ];

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `${text}<div class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        if(type === 'bot') somNotificacao.play().catch(() => {});
    }

    function showTypingAndRespond(text, callback) {
        typingIndicator.style.display = 'block';
        setTimeout(() => {
            typingIndicator.style.display = 'none';
            addMessage(text, 'bot');
            if(callback) callback();
        }, 1500);
    }

    function exibirTopicosDeAjuda() {
        // Evita exibir t√≥picos se j√° estivermos em um modo especial
        if (modoInventario || modoGratidao) return;

        const topicos = [
            { texto: "üò∞ Ansiedade/Medo", valor: "Estou ansioso" },
            { texto: "üö® Crise de P√¢nico", valor: "Estou em crise" },
            { texto: "üå± Reforma de Car√°ter", valor: "reforma de carater" },
            { texto: "ü§Ø Sobrecarga/Stress", valor: "Estou sobrecarregado" },
            { texto: "üíî Solid√£o", valor: "Sinto-me sozinho" },
            { texto: "‚ú® Praticar Gratid√£o", valor: "gratid√£o" },
            { texto: "üìä Meu Progresso", valor: "progresso" }
        ];
        const container = document.createElement('div');
        container.className = 'topics-container';
        topicos.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'topic-btn' + (t.texto.includes("üö®") ? " emergency" : "");
            btn.innerText = t.texto;
            btn.onclick = () => { userInput.value = t.valor; processarEntrada(); container.remove(); };
            container.appendChild(btn);
        });
        chatWindow.appendChild(container);
    }

    function analisarEGerarFeedback() {
        let feedback = "";
        const todasRespostas = respostasInventario.join(" ").toLowerCase();

        if (todasRespostas.includes("sim") || todasRespostas.includes("orgulho") || todasRespostas.includes("raiva") || todasRespostas.includes("ego")) {
            feedback = "üìä **Feedback Sincero:** Identificamos que o orgulho ou raiva dominaram. **A corre√ß√£o:** A cura exige quebrar o ego. Pratique a humildade ainda hoje e pe√ßa desculpas se necess√°rio. N√£o deixe o ressentimento virar gatilho.";
        } else if (todasRespostas.includes("menti") || todasRespostas.includes("escondi") || todasRespostas.includes("desonesto")) {
            feedback = "üìä **Feedback Sincero:** A desonestidade √© o veneno da alma. **A corre√ß√£o:** Admita a verdade imediatamente. Viver na mentira cria um peso insuport√°vel. A transpar√™ncia √© sua prote√ß√£o.";
        } else {
            feedback = "üìä **Feedback Sincero:** Olhar para si exige coragem. **A corre√ß√£o:** Se houve ego√≠smo, pratique um ato de servi√ßo desinteressado agora. Saia do 'eu' e foque no 'outro'.";
        }

        modoInventario = false; // Reseta antes para permitir os t√≥picos no final
        showTypingAndRespond(feedback, () => {
            setTimeout(() => {
                showTypingAndRespond("Invent√°rio conclu√≠do. Como voc√™ se sente ap√≥s essa admiss√£o? Escolha um novo t√≥pico se precisar.", exibirTopicosDeAjuda);
            }, 2000);
        });

        progresso.exercicios++;
        localStorage.setItem('progresso_vFinal', JSON.stringify(progresso));
    }

    function processarEntrada() {
        const text = userInput.value.trim();
        if(!text) return;
        addMessage(text, 'user');
        userInput.value = '';
        progresso.conversas++;
        localStorage.setItem('progresso_vFinal', JSON.stringify(progresso));

        const lower = text.toLowerCase();

        // 1. L√≥gica do Invent√°rio (Prioridade M√°xima)
        if (modoInventario) {
            respostasInventario.push(text);
            etapaInventario++;
            if (etapaInventario === 1) {
                showTypingAndRespond("2. Voc√™ agiu com desonestidade ou tentou manipular alguma situa√ß√£o para seu benef√≠cio hoje? (Seja sincero)");
            } else if (etapaInventario === 2) {
                showTypingAndRespond("3. O seu orgulho ou raiva impediram voc√™ de ser √∫til a algu√©m ou de admitir um erro?");
            } else if (etapaInventario === 3) {
                analisarEGerarFeedback();
            }
            return;
        }

        // 2. In√≠cio do Invent√°rio
        if(lower.includes("carater") || lower.includes("inventario") || lower.includes("reforma")) {
            modoInventario = true;
            etapaInventario = 0;
            respostasInventario = [];
            showTypingAndRespond("Iniciando invent√°rio moral. 1. Em que momento hoje voc√™ permitiu que o ego√≠smo ou o medo guiassem suas a√ß√µes?");
            return;
        }

        // 3. L√≥gica de Gratid√£o
        if (modoGratidao) {
            showTypingAndRespond("Obrigado por compartilhar esse momento bom. Guardado! ‚ú®");
            progresso.gratidao++;
            localStorage.setItem('progresso_vFinal', JSON.stringify(progresso));
            modoGratidao = false; 
            return;
        }

        // 4. Comandos Gerais
        if(lower.includes("progresso")) {
            showTypingAndRespond(`üìä **Seu Progresso**\n\n‚ú® Gratid√µes: ${progresso.gratidao}\nüßò Exerc√≠cios: ${progresso.exercicios}\nüí¨ Conversas: ${progresso.conversas}`);
        } else if(lower.includes("gratid√£o") || lower.includes("agradecer")) {
            modoGratidao = true;
            showTypingAndRespond("‚ú® **Momento Gratid√£o**: O que aconteceu de bom hoje?");
        } else if(lower.includes("morrer") || lower.includes("desistir")) {
            showTypingAndRespond("Voc√™ n√£o est√° sozinho. A dor √© forte, mas a ajuda √© real. Ligue 188 agora (CVV).");
        } else if(lower.includes("panico") || lower.includes("ar")) {
            showTypingAndRespond("Isso √© uma crise e vai passar. Foque na sua respira√ß√£o.");
        } else {
            // Se nada for identificado e N√ÉO estivermos em modo invent√°rio, mostra t√≥picos
            showTypingAndRespond("Entendo. Como posso ajudar agora? Escolha um t√≥pico ou escreva o que sente.", exibirTopicosDeAjuda);
        }
    }

    function reiniciarConversa() { 
        modoInventario = false; 
        modoGratidao = false; 
        chatWindow.innerHTML = ''; 
        inicializarChat(); 
    }

    function inicializarChat() {
        const h = new Date().getHours();
        let s = h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        showTypingAndRespond(`${s}! Sou seu guia de bem-estar. Que bom que voc√™ est√° aqui.`);
        setTimeout(() => {
            const f = afirmacoes[Math.floor(Math.random()*afirmacoes.length)];
            showTypingAndRespond(`‚ú® **Afirma√ß√£o:**\n"${f}"`);
        }, 3000);
        setTimeout(() => showTypingAndRespond("Como posso ajudar? Escolha um t√≥pico ou escreva o que sente agora.", exibirTopicosDeAjuda), 5500);
    }

    document.getElementById('sos-btn').onclick = () => {
        sosOverlay.style.display = 'flex';
        let st = 0;
        sosInterval = setInterval(() => {
            document.getElementById('breath-circle').style.transform = st === 0 ? "scale(1.5)" : "scale(1.0)";
            document.getElementById('breath-text').innerText = st === 0 ? "Inspira" : "Expira";
            st = st === 0 ? 1 : 0;
        }, 4000);
    };

    function fecharSOS() { sosOverlay.style.display = 'none'; clearInterval(sosInterval); }
    sendBtn.onclick = processarEntrada;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') processarEntrada(); };

    window.onload = () => {
        const h = new Date().getHours();
        if(h >= 18 || h < 6) document.body.classList.add('dark-mode');
        inicializarChat();
    };
</script>
</body>
</html>
