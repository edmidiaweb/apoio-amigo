<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoio Amigo - Guia de Bem-Estar</title>
    <style>
        :root {
            --bg-chat: #e5ddd5;
            --header-color: #075e54;
            --msg-bot: #ffffff;
            --msg-user: #dcf8c6;
            --text-main: #303030;
            --text-sub: #999;
            --input-bg: #f0f0f0;
            --chat-window-bg: #efe7dd;
        }

        body.dark-mode {
            --bg-chat: #0b141a;
            --header-color: #202c33;
            --msg-bot: #202c33;
            --msg-user: #005c4b;
            --text-main: #e9edef;
            --text-sub: #8696a0;
            --input-bg: #2a3942;
            --chat-window-bg: #0b141a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-chat); display: flex; justify-content: center; height: 100vh; overflow: hidden; transition: 0.3s; }

        .chat-container { width: 100%; max-width: 450px; background: var(--chat-window-bg); display: flex; flex-direction: column; position: relative; }

        .header { background: var(--header-color); color: white; padding: 15px; display: flex; align-items: center; gap: 12px; z-index: 10; transition: 0.3s; }
        .header img { width: 40px; height: 40px; border-radius: 50%; background: #eee; }
        .header-info { flex: 1; }
        .header-info h2 { font-size: 16px; }
        .header-info p { font-size: 11px; opacity: 0.8; }
        .btn-header { background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 5px; opacity: 0.7; transition: 0.2s; }
        .btn-header:hover { opacity: 1; transform: scale(1.1); }

        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

        .message { max-width: 85%; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.5; color: var(--text-main); position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bot { background: var(--msg-bot); align-self: flex-start; border-top-left-radius: 0; }
        .user { background: var(--msg-user); align-self: flex-end; border-top-right-radius: 0; }
        .time { font-size: 10px; color: var(--text-sub); text-align: right; margin-top: 5px; }

        .topics-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; width: 85%; align-self: flex-start; }
        .topic-btn { background: var(--msg-bot); border: 1px solid var(--header-color); color: var(--text-main); padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; text-align: left; transition: 0.2s; }
        .topic-btn:hover { background: var(--input-bg); transform: translateX(5px); }
        .topic-btn.emergency { border-color: #ff4b2b; color: #ff4b2b; font-weight: bold; }

        .input-area { background: var(--input-bg); padding: 10px; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: none; border-radius: 25px; outline: none; font-size: 14px; background: var(--msg-bot); color: var(--text-main); }
        #send-btn { background: var(--header-color); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #sos-btn { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: #ff4b2b; color: white; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 99; }
        #sos-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-chat); color: var(--text-main); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        #breath-circle { width: 160px; height: 160px; border-radius: 50%; border: 3px solid #ff4b2b; display: flex; align-items: center; justify-content: center; transition: 4s ease-in-out; margin: 30px 0; }

        .typing { font-size: 12px; color: var(--text-sub); margin: 5px 15px; display: none; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" alt="Bot">
        <div class="header-info">
            <h2>Guia de Bem-Estar</h2>
            <p>Sempre aqui contigo</p>
        </div>
        <button class="btn-header" onclick="toggleTheme()">ðŸŒ“</button>
        <button class="btn-header" onclick="reiniciarConversa()">â†»</button>
    </div>

    <div id="chat-window"></div>
    <div id="typing-indicator" class="typing">digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Diz-me como te sentes...">
        <button id="send-btn">âž¤</button>
    </div>
</div>

<button id="sos-btn">SOS</button>

<div id="sos-overlay">
    <h1 style="color: #ff4b2b;">Respira fundo</h1>
    <p>Acompanha o cÃ­rculo para estabilizar o teu coraÃ§Ã£o.</p>
    <div id="breath-circle"><span id="breath-text" style="color:#ff4b2b; font-weight:bold;">Inspirar</span></div>
    <div style="max-width: 350px; width: 100%;">
        <a href="tel:188" style="display: block; background: #ff4b2b; color: white; padding: 15px; text-decoration: none; border-radius: 30px; margin-bottom: 15px; font-weight: bold;">LIGAR PARA O CVV (188)</a>
        <button onclick="fecharSOS()" style="background: none; border: 1px solid var(--text-sub); padding: 10px 20px; border-radius: 20px; cursor: pointer; color: var(--text-sub);">Estou melhor, voltar</button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const somNotificacao = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

    let modoGratidao = false;
    let sosInterval;
    let progresso = JSON.parse(localStorage.getItem('progresso_bemestar')) || { gratidao: 0, exercicios: 0, conversas: 0 };

    const afirmacoes = [
        "Sou capaz de lidar com qualquer desafio de hoje.",
        "A minha sensibilidade Ã© a minha maior forÃ§a.",
        "Respeito o meu ritmo e honro os meus progressos.",
        "Um dia menos bom nÃ£o define a minha vida.",
        "Sou digno(a) de paz e cuidado agora.",
        "Eu nÃ£o preciso ser perfeito(a) para ser incrÃ­vel. Eu jÃ¡ sou o suficiente agora.",
        "Eu tenho o direito de estabelecer limites que protejam a minha paz mental.",
        "Minha jornada Ã© Ãºnica, e eu nÃ£o preciso me comparar com o ritmo de ninguÃ©m.",
        "Eu escolho focar no que eu posso controlar e soltar o que nÃ£o depende de mim.",
        "A cada respiraÃ§Ã£o, eu libero as tensÃµes do passado e me abro para a calma do presente."
    ];

    const sentimentos = {
        crise: { keywords: ["morrer", "suicidio", "largar", "desistir", "fim"], resposta: "Sinto que a dor Ã© intensa. NÃ£o estÃ¡s sozinho(a). Liga 188 (CVV) agora, eles estÃ£o disponÃ­veis para te ouvir com carinho." },
        panico: { keywords: ["panico", "ar", "coracao", "formigamnto", "desespero"], resposta: "Isso vai passar, Ã© uma resposta fÃ­sica. Vamos focar na tua respiraÃ§Ã£o?", exercicio: "respiracao" },
        sobrecarga: { keywords: ["cansado", "exaurido", "pressao","quebrado", "burnout", "muito"], resposta: "Parece que o mundo estÃ¡ pesado. Lembra-te: nÃ£o precisas de resolver tudo agora.", exercicio: "ativacao" },
        solidao: { keywords: ["sozinho", "isolado", "perdido", "solidao"], resposta: "A solidÃ£o dÃ³i, mas eu estou aqui contigo. Que tal acolheres a tua prÃ³pria companhia hoje?", exercicio: "aterramento" },
        ansiedade: { keywords: ["medo", "futuro", "ansioso", "angustia"], resposta: "A ansiedade tenta levar-te para um futuro incerto. Vamos voltar ao presente?", exercicio: "aterramento" }
    };

    const exercicios = {
        respiracao: { titulo: "ðŸŒ¬ï¸ RespiraÃ§Ã£o Quadrada", passos: "Inspira (4s) -> Segura (4s) -> Expira (4s) -> Espera (4s)." },
        aterramento: { titulo: "ðŸ§˜ TÃ©cnica 5-4-3-2-1", passos: "Diz: 5 coisas que vÃªs, 4 que tocas, 3 sons, 2 cheiros, 1 sabor." },
        ativacao: { titulo: "ðŸš¶ Pausa de AlÃ­vio", passos: "Bebe Ã¡gua devagar ou estica os braÃ§os para cima por 15 segundos." }
    };

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `${text}<div class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        if(type === 'bot') somNotificacao.play().catch(() => {});
    }

    function showTypingAndRespond(text, callback) {
        typingIndicator.style.display = 'block';
        setTimeout(() => {
            typingIndicator.style.display = 'none';
            addMessage(text, 'bot');
            if(callback) callback();
        }, 1500);
    }

    function exibirTopicosDeAjuda() {
        const topicos = [
            { texto: "ðŸ˜° Ansiedade/Medo", valor: "Estou ansioso" },
            { texto: "ðŸš¨ Crise de PÃ¢nico", valor: "Estou em crise" },
            { texto: "ðŸ¤¯ Sobrecarga/Stress", valor: "Estou sobrecarregado" },
            { texto: "ðŸ’” SolidÃ£o", valor: "Sinto-me sozinho" },
            { texto: "âœ¨ GratidÃ£o", valor: "gratidao" },
            { texto: "ðŸ“Š O meu Progresso", valor: "progresso" }
        ];
        const container = document.createElement('div');
        container.className = 'topics-container';
        topicos.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'topic-btn' + (t.texto.includes("ðŸš¨") ? " emergency" : "");
            btn.innerText = t.texto;
            btn.onclick = () => { userInput.value = t.valor; processarEntrada(); container.remove(); };
            container.appendChild(btn);
        });
        chatWindow.appendChild(container);
    }

    function processarEntrada() {
        const text = userInput.value.trim();
        if(!text) return;
        addMessage(text, 'user');
        userInput.value = '';
        progresso.conversas++;
        localStorage.setItem('progresso_bemestar', JSON.stringify(progresso));

        if(modoGratidao) {
            showTypingAndRespond("Obrigado por partilhares. Guardei esse momento no teu histÃ³rico! âœ¨");
            progresso.gratidao++;
            localStorage.setItem('progresso_bemestar', JSON.stringify(progresso));
            modoGratidao = false; return;
        }

        const lower = text.toLowerCase();
        if(lower.includes("progresso")) {
            showTypingAndRespond(`ðŸ“Š **O teu Progresso**\n\nâœ¨ GratidÃµes: ${progresso.gratidao}\nðŸ§˜ ExercÃ­cios: ${progresso.exercicios}\nðŸ’¬ Conversas: ${progresso.conversas}`);
            return;
        }
        if(lower.includes("gratidao")) {
            modoGratidao = true;
            showTypingAndRespond("âœ¨ **Momento GratidÃ£o**: O que aconteceu de bom hoje?");
            return;
        }

        let iden = false;
        for(let s in sentimentos) {
            if(sentimentos[s].keywords.some(k => lower.includes(k))) {
                showTypingAndRespond(sentimentos[s].resposta, () => {
                    if(sentimentos[s].exercicio) {
                        const ex = exercicios[sentimentos[s].exercicio];
                        setTimeout(() => {
                            showTypingAndRespond(`**${ex.titulo}**\n${ex.passos}`);
                            progresso.exercicios++;
                            localStorage.setItem('progresso_bemestar', JSON.stringify(progresso));
                        }, 2000);
                    }
                });
                iden = true; break;
            }
        }
        if(!iden) showTypingAndRespond("Estou a ouvir-te. Algum destes temas descreve como te sentes?", exibirTopicosDeAjuda);
    }

    function reiniciarConversa() { chatWindow.innerHTML = ''; inicializarChat(); }

    function inicializarChat() {
        const h = new Date().getHours();
        let s = h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        showTypingAndRespond(`${s}! Sou o teu guia. Que bom estares aqui.`);
        setTimeout(() => {
            const f = afirmacoes[Math.floor(Math.random()*afirmacoes.length)];
            showTypingAndRespond(`âœ¨ **AfirmaÃ§Ã£o:**\n"${f}"`);
        }, 3000);
        setTimeout(() => showTypingAndRespond("Como posso ajudar-te agora? Escolha um tÃ³pico ou escreva o que estÃ¡ sentindo agora.", exibirTopicosDeAjuda), 5000);
    }

    document.getElementById('sos-btn').onclick = () => {
        sosOverlay.style.display = 'flex';
        let st = 0;
        sosInterval = setInterval(() => {
            document.getElementById('breath-circle').style.transform = st === 0 ? "scale(1.6)" : "scale(1.0)";
            document.getElementById('breath-text').innerText = st === 0 ? "Inspira" : "Expira";
            st = st === 0 ? 1 : 0;
        }, 4000);
    };

    function fecharSOS() { sosOverlay.style.display = 'none'; clearInterval(sosInterval); }
    sendBtn.onclick = processarEntrada;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') processarEntrada(); };

    window.onload = () => {
        const h = new Date().getHours();
        if(h >= 18 || h < 6) document.body.classList.add('dark-mode');
        inicializarChat();
    };
</script>
</body>
</html>
